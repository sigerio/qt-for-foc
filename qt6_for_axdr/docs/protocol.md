# AxDr电机控制器 Modbus RTU 通信协议

## 1. 通信参数

| 参数 | 值 |
|------|-----|
| 波特率 | 115200 |
| 数据位 | 8 |
| 校验位 | 无 |
| 停止位 | 1 |
| 从机地址 | 1 (可配置) |

## 2. 支持的功能码

| 功能码 | 名称 | 说明 |
|--------|------|------|
| 0x03 | 读保持寄存器 | 读取一个或多个寄存器 |
| 0x06 | 写单个寄存器 | 写入单个寄存器 |
| 0x10 | 写多个寄存器 | 写入多个连续寄存器 |

## 3. 数据格式

### 3.1 寄存器长度
- 单个寄存器: 16位 (2字节)

### 3.2 浮点数存储格式
- 占用2个连续寄存器
- **小端序**: 低地址存低16位，高地址存高16位
- IEEE 754单精度浮点数

**示例**: float值 `0.1` 的存储
```
IEEE 754: 0x3DCCCCCD
寄存器n (低16位):   0xCCCD
寄存器n+1 (高16位): 0x3DCC
```

### 3.3 整数存储格式
- 单个寄存器存储16位无符号整数

## 4. 寄存器映射表

### 4.1 PID参数 (读写)

| 地址 | 名称 | 类型 | 说明 |
|------|------|------|------|
| 0x0000-0x0001 | Kp_current | float | 电流环比例系数 |
| 0x0002-0x0003 | Ki_current | float | 电流环积分系数 |
| 0x0004-0x0005 | Kd_current | float | 电流环微分系数 |
| 0x0006-0x0007 | Kp_velocity | float | 速度环比例系数 |
| 0x0008-0x0009 | Ki_velocity | float | 速度环积分系数 |
| 0x000A-0x000B | Kd_velocity | float | 速度环微分系数 |
| 0x000C-0x000D | Kp_position | float | 位置环比例系数 |
| 0x000E-0x000F | Ki_position | float | 位置环积分系数 |
| 0x0010-0x0011 | Kd_position | float | 位置环微分系数 |

### 4.2 电机参数 (读写)

| 地址 | 名称 | 类型 | 说明 |
|------|------|------|------|
| 0x0020 | pole_pairs | uint16 | 极对数 |
| 0x0021 | reserved | - | 预留 |
| 0x0022-0x0023 | phase_resistance | float | 相电阻 (Ω) |
| 0x0024-0x0025 | phase_inductance | float | 相电感 (H) |
| 0x0026-0x0027 | torque_constant | float | 转矩常数 (Nm/A) |

### 4.3 限制参数 (读写)

| 地址 | 名称 | 类型 | 说明 |
|------|------|------|------|
| 0x0030-0x0031 | current_limit | float | 电流限制 (A) |
| 0x0032-0x0033 | velocity_limit | float | 速度限制 (rpm) |
| 0x0034-0x0035 | voltage_limit | float | 电压限制 (V) |

### 4.4 编码器参数 (读写)

| 地址 | 名称 | 类型 | 说明 |
|------|------|------|------|
| 0x0040-0x0041 | encoder_cpr | float | 编码器每转脉冲数 |
| 0x0042-0x0043 | encoder_offset | float | 编码器偏移 |

### 4.5 保护参数 (读写)

| 地址 | 名称 | 类型 | 说明 |
|------|------|------|------|
| 0x0050-0x0051 | over_voltage | float | 过压保护阈值 (V) |
| 0x0052-0x0053 | under_voltage | float | 欠压保护阈值 (V) |
| 0x0054-0x0055 | over_temp | float | 过温保护阈值 (°C) |

### 4.6 控制模式 (读写)

| 地址 | 名称 | 类型 | 说明 |
|------|------|------|------|
| 0x0060 | control_mode | uint16 | 0=力矩, 1=速度, 2=位置 |

### 4.7 实时数据 (只读)

| 地址 | 名称 | 类型 | 说明 |
|------|------|------|------|
| 0x0100-0x0101 | velocity | float | 当前速度 (rpm) |
| 0x0102-0x0103 | position | float | 当前位置 (rad) |
| 0x0104-0x0105 | current_q | float | Q轴电流 (A) |
| 0x0106-0x0107 | current_d | float | D轴电流 (A) |
| 0x0108-0x0109 | voltage_bus | float | 母线电压 (V) |
| 0x010A-0x010B | temperature | float | 温度 (°C) |

## 5. 帧格式

### 5.1 请求帧通用格式
```
[从机地址(1)] [功能码(1)] [数据(N)] [CRC低(1)] [CRC高(1)]
```

### 5.2 CRC16计算
- 多项式: 0xA001
- 初始值: 0xFFFF
- CRC低字节在前，高字节在后

## 6. 协议示例

---

### 6.1 PID参数

#### 6.1.1 读取电流环PID (0x0000, 6个寄存器)

请求:
```
01 03 00 00 00 06 C5 C8
```

响应 (Kp=0.1, Ki=0.01, Kd=0):
```
01 03 0C CC CD 3D CC D7 0A 3C 23 00 00 00 00 [CRC]
```

#### 6.1.2 写入电流环PID (Kp=0.1, Ki=0.01, Kd=0)

请求:
```
01 10 00 00 00 06 0C CC CD 3D CC D7 0A 3C 23 00 00 00 00 6C 68
```

响应:
```
01 10 00 00 00 06 C1 C8
```

#### 6.1.3 读取速度环PID (0x0006, 6个寄存器)

请求:
```
01 03 00 06 00 06 E4 09
```

响应 (Kp=1.0, Ki=0.1, Kd=0):
```
01 03 0C 00 00 3F 80 CC CD 3D CC 00 00 00 00 [CRC]
```

#### 6.1.4 写入速度环PID (Kp=1.0, Ki=0.1, Kd=0)

请求:
```
01 10 00 06 00 06 0C 00 00 3F 80 CC CD 3D CC 00 00 00 00 [CRC]
```

#### 6.1.5 读取位置环PID (0x000C, 6个寄存器)

请求:
```
01 03 00 0C 00 06 45 CA
```

#### 6.1.6 写入位置环PID (Kp=10.0, Ki=0.5, Kd=0.01)

请求:
```
01 10 00 0C 00 06 0C 00 00 41 20 00 00 3F 00 D7 0A 3C 23 [CRC]
```
数据: Kp=10.0(0x41200000), Ki=0.5(0x3F000000), Kd=0.01(0x3C23D70A)

---

### 6.2 电机参数

#### 6.2.1 读取电机参数 (0x0020, 8个寄存器)

请求:
```
01 03 00 20 00 08 45 C3
```

响应 (极对数=7, 相电阻=0.5Ω, 相电感=0.001H, 转矩常数=0.1):
```
01 03 10 00 07 00 00 00 00 3F 00 6F 12 3A 83 CC CD 3D CC [CRC]
```
| 字节 | 值 | 说明 |
|------|-----|------|
| 00 07 | 7 | pole_pairs (整型) |
| 00 00 | 0 | reserved |
| 00 00 3F 00 | 0.5 | phase_resistance |
| 6F 12 3A 83 | 0.001 | phase_inductance |
| CC CD 3D CC | 0.1 | torque_constant |

#### 6.2.2 写入电机参数

请求:
```
01 10 00 20 00 08 10 00 07 00 00 00 00 3F 00 6F 12 3A 83 CC CD 3D CC [CRC]
```

#### 6.2.3 只写入极对数 (0x0020, 单寄存器)

请求:
```
01 06 00 20 00 07 C8 04
```

响应:
```
01 06 00 20 00 07 C8 04
```

---

### 6.3 限制参数

#### 6.3.1 读取限制参数 (0x0030, 6个寄存器)

请求:
```
01 03 00 30 00 06 C4 04
```

响应 (电流限制=10A, 速度限制=3000rpm, 电压限制=24V):
```
01 03 0C 00 00 41 20 00 00 45 3B 80 00 00 41 C0 [CRC]
```
| 值 | float | 说明 |
|-----|-------|------|
| 00 00 41 20 | 10.0 | current_limit (A) |
| 00 00 45 3B 80 | 3000.0 | velocity_limit (rpm) |
| 00 00 41 C0 | 24.0 | voltage_limit (V) |

#### 6.3.2 写入限制参数 (电流=10A, 速度=3000rpm, 电压=24V)

请求:
```
01 10 00 30 00 06 0C 00 00 41 20 00 00 45 3B 80 00 00 41 C0 [CRC]
```

---

### 6.4 编码器参数

#### 6.4.1 读取编码器参数 (0x0040, 4个寄存器)

请求:
```
01 03 00 40 00 04 44 1A
```

响应 (CPR=4096, offset=0):
```
01 03 08 00 00 45 80 00 00 00 00 [CRC]
```

#### 6.4.2 写入编码器参数 (CPR=4096, offset=0.5)

请求:
```
01 10 00 40 00 04 08 00 00 45 80 00 00 3F 00 [CRC]
```

---

### 6.5 保护参数

#### 6.5.1 读取保护参数 (0x0050, 6个寄存器)

请求:
```
01 03 00 50 00 06 C4 1C
```

响应 (过压=28V, 欠压=10V, 过温=80°C):
```
01 03 0C 00 00 41 E0 00 00 41 20 00 00 42 A0 [CRC]
```

#### 6.5.2 写入保护参数

请求:
```
01 10 00 50 00 06 0C 00 00 41 E0 00 00 41 20 00 00 42 A0 [CRC]
```

---

### 6.6 控制模式

#### 6.6.1 读取控制模式 (0x0060, 1个寄存器)

请求:
```
01 03 00 60 00 01 85 D6
```

响应 (速度模式=1):
```
01 03 02 00 01 79 84
```

#### 6.6.2 写入控制模式 (速度模式=1)

请求:
```
01 06 00 60 00 01 48 1C
```

响应:
```
01 06 00 60 00 01 48 1C
```

控制模式值:
| 值 | 模式 |
|-----|------|
| 0 | 力矩模式 |
| 1 | 速度模式 |
| 2 | 位置模式 |

---

### 6.7 实时数据 (只读)

#### 6.7.1 读取全部实时数据 (0x0100, 12个寄存器)

请求:
```
01 03 01 00 00 0C 45 F6
```

响应:
```
01 03 18 [velocity_L] [velocity_H] [position_L] [position_H] 
         [current_q_L] [current_q_H] [current_d_L] [current_d_H]
         [voltage_L] [voltage_H] [temp_L] [temp_H] [CRC]
```

#### 6.7.2 只读取速度 (0x0100, 2个寄存器)

请求:
```
01 03 01 00 00 02 C5 F4
```

响应 (速度=1500rpm):
```
01 03 04 00 00 44 BB 80 [CRC]
```

#### 6.7.3 只读取位置 (0x0102, 2个寄存器)

请求:
```
01 03 01 02 00 02 64 34
```

#### 6.7.4 只读取Q轴电流 (0x0104, 2个寄存器)

请求:
```
01 03 01 04 00 02 85 F5
```

---

### 6.8 异常响应

当从机检测到错误时，返回异常响应:
```
01 83 02 C0 F1
│  │  │  └───── CRC16
│  │  └──────── 异常码
│  └─────────── 功能码 | 0x80
└────────────── 从机地址
```

异常码:
| 代码 | 说明 |
|------|------|
| 0x01 | 非法功能码 |
| 0x02 | 非法数据地址 |
| 0x03 | 非法数据值 |

## 7. 常用浮点数对照表

| 值 | IEEE 754 (Hex) | 寄存器0 (低) | 寄存器1 (高) |
|----|----------------|--------------|--------------|
| 0.0 | 0x00000000 | 0x0000 | 0x0000 |
| 0.01 | 0x3C23D70A | 0xD70A | 0x3C23 |
| 0.1 | 0x3DCCCCCD | 0xCCCD | 0x3DCC |
| 0.5 | 0x3F000000 | 0x0000 | 0x3F00 |
| 1.0 | 0x3F800000 | 0x0000 | 0x3F80 |
| 10.0 | 0x41200000 | 0x0000 | 0x4120 |
| 100.0 | 0x42C80000 | 0x0000 | 0x42C8 |
| 1000.0 | 0x447A0000 | 0x0000 | 0x447A |
