# 设计文档: Modbus从机模拟器和测试模式

## Context
开发阶段需要测试Modbus通信功能，用户会提供物理串口连接（如USB转TTL线环回）。
需要实现独立的从机模拟器窗口，支持实时监测和动态修改寄存器数据。

## Goals
- 实现Modbus RTU从机协议，模拟AxDr控制板响应
- 通过物理串口进行真实通信测试
- 提供独立的从机模拟器窗口，支持数据监测和动态修改
- 测试数据可通过JSON配置文件自定义
- 与现有主机代码解耦，可独立运行

## Non-Goals
- 不实现完整的Modbus从机协议栈（仅实现项目所需功能码）
- 不支持多从机模拟
- 不实现网络版Modbus TCP

## Decisions

### 通信方案: 物理串口连接

采用真实物理串口通信：
- 用户使用USB转TTL线进行TX/RX环回连接
- 主机程序连接串口A，从机模拟器连接串口B（或同一串口的环回）
- 测试真实串口时序和通信特性

### 从机模拟器独立窗口

从机模拟器作为独立窗口运行，提供：
- 串口配置（端口、波特率等）
- 寄存器表格视图（实时显示当前值）
- 寄存器值动态编辑（双击或输入框修改）
- 通信日志显示（收发数据包）
- 配置文件加载/保存

### 测试数据配置方案

采用JSON配置文件存储测试数据：
```json
{
  "registers": {
    "0x0000": { "name": "Kp_current", "value": 1000 },
    "0x0001": { "name": "Ki_current", "value": 100 }
  },
  "response_delay_ms": 50
}
```

### 架构设计

```
┌─────────────────────────────────────────────────────────┐
│                    主窗口 (MainWindow)                   │
│  ┌─────────────────┐                                    │
│  │  modbus_client  │──────物理串口A────────┐            │
│  │    (主机)       │                       │            │
│  └─────────────────┘                       │            │
└─────────────────────────────────────────────│────────────┘
                                             │
                              ┌──────────────┴──────────────┐
                              │        物理连接              │
                              │   (TX/RX环回或双串口)        │
                              └──────────────┬──────────────┘
                                             │
┌─────────────────────────────────────────────│────────────┐
│              从机模拟器窗口 (SlaveWindow)    │            │
│  ┌─────────────────┐                       │            │
│  │  modbus_slave   │──────物理串口B────────┘            │
│  │   (从机模拟)    │                                    │
│  └────────┬────────┘                                    │
│           │                                             │
│  ┌────────┴────────┐  ┌─────────────┐  ┌────────────┐  │
│  │ 寄存器表格视图   │  │ 通信日志    │  │ 配置管理   │  │
│  │ (动态编辑)      │  │ (收发显示)  │  │ (JSON)    │  │
│  └─────────────────┘  └─────────────┘  └────────────┘  │
└─────────────────────────────────────────────────────────┘
```

## Risks / Trade-offs
- **风险**: 需要两个串口或串口环回硬件
  - **缓解**: 文档说明测试环境搭建方法
- **风险**: 测试数据与实际设备不一致
  - **缓解**: 从实际设备导出寄存器映射表作为默认配置
